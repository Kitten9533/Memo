<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="css/mui.min.css">
		<link rel="stylesheet" href="css/app.css">
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			p {
				/*text-indent: 22px;*/
				text-indent:0;
			}
			.mui-table-view-cell{
				background: rgba(255,255,255,0);
			}
			.mui-table-cell{
				background: rgba(255,255,255,0);
			}
			.frosted-glass{   
		        width: 100%;   
		        height: 100%;   
		        background: inherit;   
		        -webkit-filter: blur(5px);   
		        -moz-filter: blur(5px);   
		        -ms-filter: blur(5px);   
		        -o-filter: blur(5px);   
		        filter: blur(5px);   
		        filter: progid:DXImageTransform.Microsoft.Blur(PixelRadius=4, MakeShadow=false);   
		    }  
			span.mui-icon {
				font-size: 14px;
				color: #007aff;
				margin-left: -15px;
				padding-right: 10px;
			}
			.mui-off-canvas-left {
				color: #fff;
			}
			.title {
				margin: 35px 15px 10px;
			}
			.title+.content {
				margin: 10px 15px 35px;
				color: #bbb;
				text-indent: 1em;
				font-size: 14px;
				line-height: 24px;
			}
			input {
				color: #000;
			}
			.mui-checkbox input[type=checkbox]:before {
				content: '\e411';
			}
			input[type=checkbox]:before, .mui-radio input[type=radio]:before {
				font-family: Muiicons;
				font-size: 28px;
				font-weight: 400;
				/*line-height: 1;*/
				text-decoration: none;
				color: #aaa;
				border-radius: 0;
				background: 0 0;
				-webkit-font-smoothing: antialiased;
			}
			
			
		</style>
	</head>

	<body>
		<div id="offCanvasWrapper" class="mui-off-canvas-wrap mui-draggable mui-scalable">
<!--侧滑菜单部分-->
			<aside id="offCanvasSide" class="mui-off-canvas-left">
				<div id="offCanvasSideScroll" class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<div class="title">我的</div>
						<div class="content">
							<span class="android-only">
							</span>
							<p style="margin: 10px 15px;">
								<button id="offCanvasHide" type="button" class="mui-btn mui-btn-danger mui-btn-block" style="padding: 5px 20px;">Back</button>
							</p>

						</div>
						<div class="title" style="margin-bottom: 25px;">侧滑列表示例</div>
						<ul class="mui-table-view mui-table-view-chevron mui-table-view-inverted">
							<li class="mui-table-view-cell">
								<a id="new" class="mui-navigate-right">
									new
								</a>
							</li>
							<li class="mui-table-view-cell">
								<a id="showAll" class="mui-navigate-right">
									showAll
								</a>
							</li>
							<li class="mui-table-view-cell" style="display:none;">
								<a id="clearAll" class="mui-navigate-right">
									clearAll
								</a>
							</li>
							
							<li class="mui-table-view-cell">
								<a id="batchDelete" class="mui-navigate-right">
									批量删除
								</a>
							</li>
						</ul>
					</div>
				</div>
			</aside>
			<!--主界面部分-->
			<div class="mui-inner-wrap">
				<header class="mui-bar mui-bar-nav">
					<a href="#offCanvasSide" class="mui-icon mui-action-menu mui-icon-bars mui-pull-left"></a>
					<!--<a class="mui-action-back mui-btn mui-btn-link mui-pull-right" href="#topPopover">关闭</a>-->
					<a class="mui-btn mui-btn-link mui-pull-right" href="#topPopover">菜单</a>
					<h1 class="mui-title">首页</h1>
				</header>
				<div id="offCanvasContentScroll" class="mui-content mui-scroll-wrapper">

					<div class="mui-scroll">
		
						<div class="mui-card" style="margin:6px;">

							<ul id="myPlanBox" class="mui-table-view"">
								<li class="mui-table-view-cell" style="border-radius: 0px;">
									<div class="mui-slider-right mui-disabled">
										<a class="mui-btn mui-btn-red">删除</a>
									</div>
									<div class="mui-slider-left mui-disabled">
										<a class="mui-btn mui-btn-success">信息</a>
									</div>
									<div class="mui-slider-handle">
										<p><input type="checkbox" class="mui-pull-left"><span class="mui-pull-left">左滑显示多功能菜单</span><span class="mui-pull-right">16/8/1</span></p>
									</div>
								</li>
							
								<li class="mui-table-view-cell" style="border-radius: 0px;">
									<div class="mui-slider-right mui-disabled">
										<a class="mui-btn mui-btn-red">删除</a>
									</div>
									<div class="mui-slider-left mui-disabled">
										<a class="mui-btn mui-btn-success">信息</a>
									</div>
									<div class="mui-slider-handle mui-checkbox">
										<input type="checkbox">
										<p><span class="mui-pull-left">左滑显示多功能菜单</span><span class="mui-pull-right">16/8/1</span></p>
									</div>
								</li>
							</ul>
						</div>									
					</div>
				</div>
				
				<!-- off-canvas backdrop -->
				<div class="mui-off-canvas-backdrop"></div>
			</div>
		</div>
		
		<div id="topPopover" class="mui-popover" style="width:120px;">
		  <ul class="mui-table-view">
		    <li class="mui-table-view-cell"><a href="#"><p>新建</p></a></li>
		    <li class="mui-table-view-cell"><a href="#"><p>批量删除</p></a></li>
		  </ul>
		</div>
		
		<script src="js/mui.min.js"></script>
		<script src="js/config.js"></script>
		<script src="js/jquery-1.9.1.min.js"></script>
 		     
		<script>
			mui.init();
			//databasename:数据库名；version：数据库版本号，可不填；description：数据库描述；size：给数据库分配的空间大小；
			var db = openDatabase('myplan','','local database',1024*1024);
			mui.plusReady(function(){
				//getData();
				loadData();
				SideScroll();
				getLocalData();
			});
			
			function getData(){
				mui.ajax({
					url:ServiceUrl + "/MyApp/2.php",
					dataType:"text",
					type:"post",
					async:false,
					data:{
						
					},
					success:function(data){
						mui.toast(data);
					},
					error:function(e){
						mui.toast("error");
					}
				});	
			}
			
			function getLocalData(){
				if(!db){
					mui.toast("数据库创建失败！");
				}
				else{
					mui.toast("创建成功！");
				}
				
				
			}
			
			document.getElementById("new").addEventListener("tap",function(){
				mui.openWindow("add.html");
			});
			
			document.getElementById("clearAll").addEventListener("tap",function(){
				localStorage.clear();
				loadData();
			});
			
			document.getElementById("showAll").addEventListener("tap",function(){
				loadAll();
				loadData();
			});
			
			function loadAll(){
				var str = "";
				if(localStorage.length > 0){
					for(var i = 0;i < localStorage.length;i++){
						var time = localStorage.key(i);
						var memo = localStorage.getItem(time);
						str += i + ":" + time + "," + memo + ".............";
					}
					alert(str);
				}
				else{
					mui.toast("null");
				}
			}
			
			function mySort(){
				var myarr = new Array();
				function mydata(index,time){
					this.index = index;
					this.time = time;
				}
				for(var i = 0;i < localStorage.length;i++){
					var time = (new Date(localStorage.key(i).replace(/\-/g,'/'))).getTime();
					myarr.push(new mydata(i,time));
				}
				//time从大到小排
				
				myarr.sort(function(a,b){
					return b.time - a.time}
				);
				//console.log(myarr.length);
				return myarr;
				 
			}
					
			function loadData(){
				var arr = mySort();
				var str = "";
				var time_now = new Date();			//today
				var time_last = time_now.getTime() - 24 * 60 * 60 * 1000;		//yesterday
				if(localStorage.length > 0){
					for(var i = 0;i < arr.length;i++){
						var time = localStorage.key(arr[i].index);
						//console.log(time);
						var memo = localStorage.getItem(time);
						//console.log(memo_sub);
						var time_show;//显示的时间
						if(time.substr(0,10) == time_now.format("yyyy-MM-dd")){//today   time_show    15:37
							time_show = time.substr(11,5);
						}
						else if(time.substr(0,10) == (new Date(time_last)).format("yyyy-MM-dd")){//yesterday    time_show	yesterday
							time_show = "yesterday";
						}
						else{//else	  time_show     16/8/1
							time_show = (new Date(time.replace(/\-/g,'/'))).format("yy/MM/dd");
							if(time_show == "N/aN/aN"){
								time_show = "";
							}
						}
						
						
						if(memo.length > 20){
							memo = memo.substring(0,20) + "···";
						}
						if(!!time_show){
							
							str +='<li class="mui-table-view-cell" name="my_li" key="'+ time +'" style="border-radius: 0px;">'
								+   '</div>'
								+	'<div class="mui-slider-right mui-disabled">'
								+		'<a class="mui-btn mui-btn-red" name="delete" key="'+ time + '">删除</a>'
								+	'</div>'
								+	'<div class="mui-slider-left mui-disabled">'
								+		'<a class="mui-btn mui-btn-success" name="send" key="'+ time +'" onclick="alert(\'aaa\');">信息</a>'
								+	'</div>'
								+	'<div class="mui-slider-handle">'
								+		'<p><span class="mui-pull-left" name="memo" key="'+ time +'">'+ memo +'</span><span class="mui-pull-right" name="time" key="'+ time +'">'+ time_show +'</span></p>'
								+	'</div>'
							+	'</li>';
						}
	
					}
				}
				$("#myPlanBox").html(str);
				
				//send
				
			}
			
				mui("#myPlanBox").on("tap","[name='send']",function(){
					var text = localStorage.getItem(this.getAttribute("key"));
					console.log(text);
					self.sms("",text);

				});
				
				//sms
				self.sms=function(number,text){
			        if (plus.os.name == "Android") {
			
			            var Intent = plus.android.importClass("android.content.Intent");
			            var Uri = plus.android.importClass("android.net.Uri");
			
			            var uri = Uri.parse("smsto:"+number);  
			
			            var intent = new Intent(Intent.ACTION_SENDTO, uri);  
			            intent.putExtra("sms_body", "");  
			
			            plus.android.runtimeMainActivity().startActivity(intent);  
			        } else {
			            var UIAPP=plus.ios.importClass("UIApplication");
			            var NSURL=plus.ios.importClass("NSURL");
			            var app=UIAPP.sharedApplication();
			            app.openURL(NSURL.URLWithString("sms://"+number));
			        }
			    };			
				
				mui("#myPlanBox").on("tap","[name='delete']",function(){
					var mykey = this.getAttribute('key');
					var btnArray = ['No', 'Yes'];
					mui.confirm('Delete?', 'Memo', btnArray, function(e) {
						if (e.index == 1) {
							//yes
							localStorage.removeItem(mykey);
							$('[name="my_li"][key="'+ mykey +'"]').hide('1000');
							
						} else {
							//no
						}
						
					})

				});
				
				mui("#myPlanBox").on("tap","[name='my_li']",function(){
					mui.openWindow({
					    id:'detail',
						url:'detail.html',
						extras:{
							key:this.getAttribute('key')
						}
					});
				});
								
//				mui("#myPlanBox").on("tap",".")

//				mui('a[key]').on('tap','a[key]',function(){
//					alert(this.getAttribute('key'));
//				});
			
			document.addEventListener("SideScrollClose",function(event){
				mui("#offCanvasWrapper").offCanvas('close');
				loadData();
			});
			
			document.addEventListener("loadMemo",function(event){
				loadData();
			})
			
			function SideScroll(){
				//主界面和侧滑菜单界面均支持区域滚动；
				mui('#offCanvasSideScroll').scroll();
				mui('#offCanvasContentScroll').scroll();
				//主界面‘显示侧滑菜单’按钮的点击事件
//				document.getElementById('offCanvasShow').addEventListener('tap', function() {
//					offCanvasWrapper.offCanvas('show');
//				});
				 //菜单界面，‘关闭侧滑菜单’按钮的点击事件
				document.getElementById('offCanvasHide').addEventListener('tap', function() {
					offCanvasWrapper.offCanvas('close');
				});
				 //侧滑容器父节点
				var offCanvasWrapper = mui('#offCanvasWrapper');
				 //主界面容器
				var offCanvasInner = offCanvasWrapper[0].querySelector('.mui-inner-wrap');
				 //菜单容器
				var offCanvasSide = document.getElementById("offCanvasSide");
				if (!mui.os.android) {
					//document.getElementById("move-togger").classList.remove('mui-hidden');
					var spans = document.querySelectorAll('.android-only');
					for (var i = 0, len = spans.length; i < len; i++) {
						spans[i].style.display = "none";
					}
				}		
				 //实现ios平台原生侧滑关闭页面；
				if (mui.os.plus && mui.os.ios) {
					mui.plusReady(function() { //5+ iOS暂时无法屏蔽popGesture时传递touch事件，故该demo直接屏蔽popGesture功能
						plus.webview.currentWebview().setStyle({
							'popGesture': 'none'
						});
					});
				}
				
			}
			
			


		</script>
	</body>
</html>